name: CI

on: push

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Clone other repositories
        run: bash .scripts/checkout-repos.sh
      - uses: olafurpg/setup-scala@v5
        name: Install java & sbt
        with:
          java-version: openjdk@1.8

      - name: Cache Coursier
        uses: actions/cache@v1
        with:
          path: ~/.cache/coursier
          key: ChatOverflow-Coursier-${{ hashFiles('**/*.sbt') }}-${{ hashFiles('**/build.properties') }}
          restore-keys: |
            ChatOverflow-Coursier-

      - name: Cache sbt
        uses: actions/cache@v1
        with:
          path: ~/.sbt
          key: ChatOverflow-sbt-${{ hashFiles('**/build.properties') }}
          restore-keys: |
            ChatOverflow-sbt-

      - name: Cache NPM
        uses: actions/cache@v1
        with:
          path: gui/node_modules
          key: ChatOverflow-npm-${{ hashFiles('gui/package*.json') }}
          restore-keys: |
            ChatOverflow-npm-

      - name: Compile & run tests
        run: |
          bash .scripts/authenticate-npm.sh
          sbt fetch reload compile package test "run --help"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  publish:
    name: Publish SNAPSHOT packages
    runs-on: ubuntu-latest
    needs: ci
    # don't run this in forks, because they would need all repos forked, which many won't have so this would cause errors
    if: github.ref == 'refs/heads/develop' && startsWith(github.repository, 'codeoverflow-org')
    steps:
      - uses: actions/checkout@v1
      - name: Clone other repositories
        run: bash .scripts/checkout-repos.sh
      - uses: olafurpg/setup-scala@v5
        name: Install java & sbt
        with:
          java-version: openjdk@1.8

      - name: Cache Coursier
        uses: actions/cache@v1
        with:
          path: ~/.cache/coursier
          key: ChatOverflow-Coursier-${{ hashFiles('**/*.sbt') }}-${{ hashFiles('**/build.properties') }}
          restore-keys: |
            ChatOverflow-Coursier-

      - name: Cache sbt
        uses: actions/cache@v1
        with:
          path: ~/.sbt
          key: ChatOverflow-sbt-${{ hashFiles('**/build.properties') }}
          restore-keys: |
            ChatOverflow-sbt-

      - name: Cache NPM
        uses: actions/cache@v1
        with:
          path: gui/node_modules
          key: ChatOverflow-npm-${{ hashFiles('gui/package*.json') }}
          restore-keys: |
            ChatOverflow-npm-

      - name: Publish packages
        run: |
          bash .scripts/authenticate-sbt.sh
          bash .scripts/authenticate-npm.sh

          sbt "all publishFramework apiProject/publish guiProject/publish"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_SNAPSHOT: ${{ true }}
